<html>

<body>
    <div　id="menu">
        <div id="side_dishes">

            <input type="checkbox" onclick="onTap(this)" id="gyoza">
            <label id="gyoza_label" for=gyoza>aaa</label>
            <input type="checkbox" onclick="onTap(this)" id="gyoza_vegan">
            <label for=gyoza_vegan></label>

            <br>
            <input type="checkbox" onclick="onTap(this)" id="kimchi">
            <label for=kimchi></label>
            <input type="checkbox" onclick="onTap(this)" id="fried_eryngii">
            <label for=fried_eryngii></label>

            <br>
            <input type="checkbox" onclick="onTap(this)" id="karaage">
            <label for=karaage></label>
            <input type="checkbox" onclick="onTap(this)" id="karaage_V">
            <label for=karaage_V></label>

            <br>
            <input type="checkbox" onclick="onTap(this)" id="Edamame">Edamame 3.9
            <label for=Edamame></label>

            <input type="checkbox" onclick="onTap(this)" id="Wakame_Salad">Wakame Salad 3.5
            <label for=Wakame_Salad></label>
        </div>

        <hr>
        <input type="checkbox" onclick="onTap(this)" id="Shoyu">Shoyu 10.5
        <input type="checkbox" onclick="onTap(this)" id="Shoyu_V">Shoyu_V 10.5

        <br>
        <input type="checkbox" onclick="onTap(this)" id="Torikotsu">Torikotsu 11.5
        <input type="checkbox" onclick="onTap(this)" id="Torikotsu_V">Torikotsu_V 11.5

        <br>
        <input type="checkbox" onclick="onTap(this)" id="Miso">Miso 10.5
        <input type="checkbox" onclick="onTap(this)" id="Miso_V">Miso_V 10.5

        <br>
        <input type="checkbox" onclick="onTap(this)" id="TanTan">TanTan 11.5
        <input type="checkbox" onclick="onTap(this)" id="TanTan_V">TanTan_V 11.5

        <hr>
        <div id="extra_topping_area"></div>

        <hr>
        <div id="dessert_area"></div>

        <hr>
        <div id="warm_drinks_area"></div>

        <hr>
        <div id="cold_drinks_area"></div>
    </div>

    <!-- display area-->
    <hr>
    <text id=current_item>last: </text>
    <br>
    合計額:
    <text id="subtotal_display">0</text>
    <br>
    お釣り：<text id="change_display"></text>


    <!-- TODO: お客さん申し出額の間違い検出を実装すること -->
    <br>
    申し出額(チップ込)：
    <input type="number" pattern="\d*" id="sum_asked" onchange="calcChange()">

    <br>
    受取額(チップ込)：
    <input type="number" pattern="\d*" id="sum_received" onchange="calcChange()">

    <br>
    <br>


    <!-- <button id="test_button" onclick="calcChange()">test</button> -->
    <button id="rest_button" onclick="reset()">CLEAR</button>
    

    <!-- <button id="subtotal_button" onclick="test()">subtotal</button> -->

    <!-- TODO: gyaza objectととか作って、listに追加するようにする方がいいかなあ？-->
    <!-- TODO: factory.get(Edamame)とか。-->
    <!-- TODO: 子クラスとか作れるんかなあ？SideDishesクラスの小クラスのedamameとか-->

    <script language="javascript" type="text/javascript">

        function reset(){
            let checkbox = document.querySelectorAll('input[type="checkbox"]');
            let input = document.querySelectorAll('input[type="number"]');

            checkbox.forEach(elem => elem.checked = false);
            input.forEach(elem => elem.value = "");

            // let currentItemDisplay = document.querySelector("#current_item");
            // let subtotalDisplay = document.querySelector("#subtotal_display");

            currentItemDisplay.innerText = "";
            subtotalDisplay.innerText = "0";
            document.querySelector("#change_display").innerText = "";//統一感がないが直すやる気なし。
        }

        function calcChange() {
            const sumAsked = document.querySelector("#sum_asked");
            const sumReceived = document.querySelector("#sum_received");
            let changeDisplay = document.querySelector("#change_display");

            if (!(sumAsked.value === "") && (Number(sumAsked.value) < Number(subtotalDisplay.innerText))) {
                changeDisplay.innerText = "エラー❗お客さんの申し出額が飲食合計額を下回っている！";
            }

            else if (!(sumReceived.value === "") && (Number(sumReceived.value) < Number(subtotalDisplay.innerText))) {
                changeDisplay.innerText = "エラー❗お客さんからの受取額が飲食合計額を下回っている！！";
            }

            else if (!(sumAsked.value === "") && !(sumReceived.value === "")) {
                //好奇心でNumber()を使用している
                const change = Number(sumReceived.value) - Number(sumAsked.value);
                changeDisplay.innerText = (change < 0) ? "エラー❗受取額は申し出額より多いこと！！" : change;
            }
        }

        //TODO: 将来的にはメニューとラベルのの自動生成もしたい。=>addFood()でした。
        const price = {
            "gyoza": 4.5,
            "gyoza_vegan": 5.0,
            "kimchi": 3.7,
            "fried_eryngii": 3.9,
            "karaage": 4.9,
            "karaage_V": 5.5,
            "Edamame": 3.9,
            "Wakame_Salad": 3.5,
            "Shoyu": 10.5,
            "Shoyu_V": 10.5,
            "Torikotsu": 11.5,
            "Torikotsu_V": 11.5,
            "Miso": 10.5,
            "Miso_V": 10.5,
            "TanTan": 11.5,
            "TanTan_V": 11.5
        }

        //ラベルに金額と商品名を自動セット
        let foods = document.querySelectorAll('label');
        foods.forEach(label => label.innerHTML = label.htmlFor + " " + price[label.htmlFor]);



        //下記より新バージョン//

        //メニュー自体の自動生成。まずはextra toppingから。
        const extraToppingPriceList = {
            "egg": 1.0,
            "egg_v": 1.5,
            "naruto": 1.0,
            "naruto_V": 1.5,
            "garlic": 1.0,
            "chashu": 2.0,
            "beyond_meat": 2.0,
            "eryngii": 1.5,
            "big_portion": 3.0
        };

        const dessertPriceList = {
            "mochi": 3.5,
            "stick_ice": 2.5
        };

        const warmDrinksPriceList = {
            "yuzu": 2.8,
            "plum": 2.8,
            "ginger": 2.8,
            "genmaicha": 2.8,
            "houjicha": 2.8,
        };

        const coldDrinksPriceList = {
            "erdinger": 3.5,
            "cola": 2.8,
            "sprite": 2.8,
            "ramune": 3.3,
            "greentea": 3.5,
            "aloe": 3.3,
            "peach_mango_melon_soda": 3.3,
            "mugicha": 3.5,
            "calpico": 3.0,
            "water": 2.8
        };

        const otherPriceList = {

        };


        //add to global price list.
        //TODO: なんかこれ列挙してるのきれいではないわ。。。。
        Object.assign(price, extraToppingPriceList);
        Object.assign(price, dessertPriceList);
        Object.assign(price, warmDrinksPriceList);
        Object.assign(price, coldDrinksPriceList);
        Object.assign(price, otherPriceList);


        // add food
        function addFood(area, priceList) {
            for (let [key, value] of Object.entries(priceList)) {
                let food = document.createElement("Input");
                food.setAttribute("type", "checkbox");
                food.setAttribute("onclick", "onTap(this)");
                food.setAttribute("id", key)
                area.appendChild(food);

                let label = document.createElement("Label");
                label.setAttribute("for", key);
                label.innerHTML = key + " " + value + " ";
                area.appendChild(label);

                // const br = document.createElement("br"); 
                // extraToppingArea.appendChild(br);
            }
        }


        // add food item with line break
        // (display area, pricelist, position for line break)
        function addFoodLineBreak(area, priceList, lineBreak) {
            
            let index = 0;
            for (let [key, value] of Object.entries(priceList)) {

                //TODO:外に出す =>外に出すと挙動が変わるようだ。毎回新しい要素として作成する必要があるようだ。
                //使い回すと、最後の要素が新規の要素に上書きされてしまうようだ。
                let food = document.createElement("Input");
                food.setAttribute("type", "checkbox");
                food.setAttribute("onclick", "onTap(this)");
                food.setAttribute("id", key)
                area.appendChild(food);

                let label = document.createElement("Label");
                label.setAttribute("for", key);
                label.innerHTML = key + " " + value + " ";
                area.appendChild(label);

                // lineBreakNumber = lineBreak[0];
                // isLineBreak = (index === lineBreakNumber)
                if (index === lineBreak[0]) {
                // if (isLineBreak){
                    const br = document.createElement("br");
                    area.appendChild(br);
                    lineBreak.shift();

                    console.log(index);
                    console.log(lineBreak);
                }
                index++;
            }
        }


        //TODO: これ以降も自動化したい
        // add item for extra toppings
        let extraToppingArea = document.querySelector("#extra_topping_area");
        addFoodLineBreak(extraToppingArea, extraToppingPriceList, [1, 3, 5]);

        // add item for desert
        let dessertArea = document.querySelector("#dessert_area");
        addFoodLineBreak(dessertArea, dessertPriceList, [2]);

        // add item for warm drinks
        let warmDrinksArea = document.querySelector("#warm_drinks_area");
        addFoodLineBreak(warmDrinksArea, warmDrinksPriceList, [1,3]);

        // add item for cold drinks
        let coldDrinksArea = document.querySelector("#cold_drinks_area");
        addFoodLineBreak(coldDrinksArea, coldDrinksPriceList, [2,5,7]);


        //subtotal area
        let currentItemDisplay = document.querySelector("#current_item");
        let subtotalDisplay = document.querySelector("#subtotal_display");

        // calculation
        function onTap(elem) {

            const itemName = elem.id
            const itemPrice = price[itemName];

            if (elem.checked) {
                subtotalDisplay.innerText = parseFloat(subtotalDisplay.innerText) + itemPrice;

                currentItemDisplay.innerText = "last: " + itemName + ":" + itemPrice;
            } else {
                subtotalDisplay.innerText = parseFloat(subtotalDisplay.innerText) - itemPrice;
                currentItemDisplay.innerText = "";
            }
            console.log(subtotalDisplay.innerText);
        }
    </script>

</body>

</html>